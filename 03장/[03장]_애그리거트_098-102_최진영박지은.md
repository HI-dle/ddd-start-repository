# 3.1 애그리거트

![3-1.png](image%2F3-1.png)

온라인 쇼핑몰 시스템을 개발할 때, 위 그림과 같이 상위 수준 개념을 이용해서 전체 모델을 정리하면 전반적인 관계를 이해하는데 도움이 됩니다.
> e.g) 주문은 회원, 상품, 결제와 관련이 있다는 것을 쉽게 파악 가능하다.

위의 상위 수준 모델들을 `개별 객체 단위`로 다시 그려보면 아래와 같습니다.

![3-2.png](image%2F3-2.png)

맨 처음 보았던 그림 같이 상위 모델에 대한 이해 없이 개별 객체 단위로만 상위 수준의 개념을 파악하려면 더 오랜 시간이 걸리게 되고, 결국에는 더 많은 코드를 보고 도메인
전문가와 더 많은 대화를 나눠야 비로소 상위 수준에서 모델 간의 관계가 이해되기 시작합니다.

100개 이상의 테이블을 한 장의 `ERD`에 모두 표시하면 개별 테이블 간의 관계를 파악하느라 큰 틀에서 데이터 구조를 이해하는 데 어려움을 겪게 되는 것처럼, 도메인 객체
모델이 복잡해지면 전반적인 구조나 큰 수준에서 `도메인 간의 관계를 파악하기 어려워집니다.`

`주요 도메인 요소 간의 관계를 파악하기 어렵다`는 것은 코드를 변경/확장하는 것이 어려워진다는 것을 의미합니다.

우리는 `상위 수준에서 모델이 어떻게 엮여 있는지` 알아야 `전체 모델을 망가뜨리지 않으면서` 추가 `요구사항을 모델에 반영`할 수 있는데,
세부적인 모델만 이해한 상태로는 코드를 수정하는 것이 꺼려지기 때문에 코드 변경을 최대한 회피하는 쪽으로 요구사항을 협의하게 됩니다.

꼼수를 부려 `당장 돌아가는 코드`를 추가활 수는 있지만 이런 방법은 장기적으로 코드를 더 수정하기 어렵게 만듭니다.
> 결론: 상위 수준에서 모델 간의 관계를 이해해야 코드의 변경/확장에서 자유로워진다.

---

### 애그리거트

복잡한 도메인을 이해하고 관리하기 쉬운 단위로 만들려면, `상위 수준에서 모델을 조망할 수 있는 방법`이 필요한데, 그 방법이 바로 **애그리거트**입니다.

앞장(2장)에서의 설명처럼 애그리거트는 관련된 객체를 `하나의 군`으로 묶어줍니다.

**수많은 객체를 애그리거트로 묶어서 바라보면 상위 수준에서 도메인 모델 간의 관계를 파악할 수 있습니다.**

![3-3.png](image%2F3-3.png)

위 그림은 앞선 그림을 애그리거트 단위로 묶어서 다시 표현한 것입니다. 동일한 모델이지만 애그리거트를 사용함으로써 모델 간의 관계를 `개별 모델 수준`과 `상위 수준`에서 모두
이해할 수 있게됩니다.

또한, 애그리거트는 모델을 이해하는 데 도움을 줄 뿐만 아니라 `일관성을 관리하는 기준`도 됩니다. 모델을 보다 잘 이해할 수 있고 애그리거트 단위로 일관성을 관리하기 때문에,
애그리거트는 복잡한 도메인을 단순한 구조로 만들어줍니다.

이렇게 복잡도가 낮아지는 만큼 도메인 기능을 확장하고 변경하는 데 필요한 노력(개발 시간)도 줄어들게 됩니다.

---

#### 애그리거트의 라이프 사이클
애그리거트는 관련된 모델을 하나로 모았기 때문에 한 애그리거트에 속한 객체는 유사하거나
동일한 라이프 사이클을 갖는다.

- ex: 주문 애그리거트를 만들려면 Order, OrderLine, Orderer 등 관련 객체를 함께 생성해야 한다.
  - Order는 생성했는데 ShippingInfo는 만들지 않거나 ShippingInfo를 생성하면서 Orderer를 생성하지 않는 경우는 없음
  - 도메인 규칙에 따라 최초 주문 시점에 일부 객체를 만들 필요가 없는 경우도 있다.(대부분은 함께 생성/제거)

#### 애그리거트의 경계와 독립성

- 애그리거트는 명확한 경계를 갖는 독립된 객체 집합
- 한 객체는 동시에 두 개의 애그리거트에 속할 수 없다.
- 각 애그리거트는 자기 자신만 관리하며, 다른 애그리거트를 변경하거나 관리하지 않는다.
  - ex: 주문 애그리거트는 배송지나 주문 상품 수량은 변경할 수 있지만, 회원의 비밀번호나 상품 가격은 변경하지 않습니다.

#### 애그리거트 경계 설정 기준

경계를 설정할 때 기본이 되는 것은 도메인 규칙과 요구사항이다. 

- 변경이 함께 일어나는 객체들은 동일한 애그리거트에 포함될 가능성이 높다.
  - ex
    - 주문할 상품 개수, 배송지 정보, 주문자 정보는 주문 시점에 함께 생성
    - OrderLine의 수량 변경 → 주문 금액 재계산

#### "A가 B를 갖는다" 관계 ≠ 같은 애그리거트

A가 B를 갖는다는 요구사항이 있으면 A와 B를 같은 애그리거트로 묶으려 하지만, 반드시 같은 애그리거트를 의미하지는 않는다.

- ex: Product vs Review 
  - 상품 상세 페이지에서 상품과 리뷰를 함께 보여줘야 한다는 요구사항이 있음
  - 하지만
    - Product와 Review는 함께 생성되지 않음
    - 변경 주체가 다름 (Product: 관리자 / Review: 사용자)
    - 한 쪽의 변경이 다른 쪽에 영향을 주지 않음
  - 결론: 서로 다른 애그리거트로 분리되어야 함

#### 애그리거트 크기와 도메인 이해

모델링 초기에는 많은 구성요소가 하나의 애그리거트처럼 보일 수 있지만, 도메인에 대한 이해가 깊어질수록 애그리거트는 작아지는 경향이 있다.

실제로는 하나의 엔티티만으로 구성된 애그리거트가 많고, 두 개 이상의 엔티티로 구성되는 애그리거트는 드물다.