# 아키택처 개요

---

## 2.4.2 애그리거트

 - 도메인이 커질수록 개발할 도메인 모델도 커지면서 많은 엔티티와 밸류가 출현한다. 엔티티와 밸류 개수가 많아질수록 모델은 점점 더 복잡해진다.
 - 도메인 모델이 복잡해지면 개발자가 전체 구조가 아닌 한 개 엔티티와 밸류에만 집중하는 상황이 발생한다. 이때 상위 수준에서 모델을 관리하지 않고 개별 요소에만 초점을 맞추다 보면 큰 수준에서 모델을 이해하지 못해 큰 틀에서 모델을 관리할 수없는 상황에 빠질 수 있다.

 - 지도를 볼 때 매우 상세하게 나온 대축척 지도를 보면 큰 수준에서 어디에 위치하고 있는지 이해하기 어려우므로 큰 수준에서 보여주는 소축적 지도를 함께 봐야 현재 위치를 보다 정확하게 이해할 수 있다.
 - 도메인 모델도 개별 객체뿐만 아닌 상위 수준에서 모델을 볼 수 있어야 전체 모델의 관계와 개별 모델을 이해하는 데 도움이 된다. 도메인 모델에서 전체 구조를 이해하는 데 도움이 되는 것이 애그리거트(Aggregate)이다.

---

 - **애그리거트**는 관련 객체를 하나로 묶은 군집이다. 대표적인 예시는 주문이며, 주문이라는 도메인 개념은 주문, 배송지 정보, 주문자, 주문 목록, 총 결제 금액의 하우 모델로 구성된다.
 - 이 하위 개념을 표현한 모델을 하나로 묶어 주문이라는 상위 개념으로 표현할 수 있다.

![image_2_17.png](image%2Fimage_2_17.png)


 - 애그리거트를 사용하면 개별 객체가 아닌 관련 객체를 묶어 객체 군집 단위로 모델을 바라볼 수 있게 된다.
 - 개별 객체 간 관계가 아닌 애그리거트 간 관계로 도메인 모델을 이해하고 구현하게 되며, 이를 통해 큰 틀에서 도메인 모델을 관리할 수 있다.

 - 애그리거트는 군집에 속한 객체를 관리하는 루트 엔티티를 갖는다. 루트 엔티티는 애그리거트에 속해 있는 엔티티와 밸류 객체를 이용해 애그리거트가 구현해야 할 기능을 제공한다.
 - 애그리거트를 사용하는 코드는 애그리거트 루트가 제공하는 기능을 싱행하고 애그리거트 루트를 통해 간접적으로 애그리거트 내 다른 엔티티나 밸류 객체에 접근한다. 이것은 애그리거트의 내부 구현을 숨겨서 애그리거트 단위로 구현을 캡슐화할 수 있도록 돕는다.

![image_2_18.png](image%2Fimage_2_18.png)

 - 애그리거트 루트인 Order는 주문 도메인 로직에 맞게 애그리거트의 상태를 관리한다. 예시로 Order의 배송지 정보 변경 기능은 배송지를 변경할 수 있는지 확인한 뒤 배송지 정보를 변경한다.
 - 배송이 시작된 경우 예외를 발생하는 도메인 규칙을 구현한다면 주문 애그리거트는 Order를 통하지 않고 ShippingInfo를 변경할 수 있는 방법을 제공하지 않는다.
 - 즉, 배송지를 변경하려면 루트 엔티티인 Order를 사용해야하며, Order가 구현한 도메인 로직을 항상 따르게 된다.
>애그리거트를 구현할 땐 고려할 것이 많다. 어떻게 구성하느냐에 따라 구현이 복잡해지기도 하고 트랜잭션의 범위가 달라지기도 한다. 선택한 구현 기술에 따라 애그리거트 구현에 제약이 생기기도 한다.

---

## 2.4.3 리포지터리

- 도메인 객체를 지속적으로 사용하려면 RDBMS, NOSQL, 로컬 파일과 같은 물리적 저장소에 객체를 보관해야 한다. 이를 위한 도메인 모델이 repository이다.
- 리포지터리는 애그리거트 단위로 도메인 객체를 저장하고 조회하는 기능을 정의한다.

````java
public interface UserRepository {

  boolean existsByEmail(String email);

  Optional<User> findByEmail(String email);

  User save(User user);

  Optional<User> findById(Long userId);

}
````

- 메서드를 확인하면 대상을 찾고 저장하는 단위를 애그리거트 루트를 통하는 것을 확인할 수 있다.
- 애그리거트 루트는 속한 모든 객체를 포함하고 있으므로, 결과적으로 애그리거트 단위로 저장하고 조회한다.
- 도메인 모델의 관점에서 루트 엔티티의 리포지터리는 도메인 객체를 영속화하는 데 필요한 기능을 추상화한 고수준 모듈로 구성하고 고수준 모듈을 통한 구현체를 저수준 모듈로 인프라스트럭처 계층에 속하게 한다.
![image_2_19.png](image%2Fimage_2_19.png)

- 고수준과 저수준 모듈을 구현한 모델은 위와 같고 응용 서비스는 의존 주입과 같은 방식을 통해 실제 리포지터리 구현 객체에 접근한다.
> 응용 서비스와 리포지터리의 밀접한 연관관계
> 
> 응용 서비스는 필요한 도메인 객체를 구하거나 저장할 때 리포지터리를 사용한다.
> 
> 응용 서비스는 트랜잭션을 관리하는데, 트랜잭션 처리는 리포지터리 구현 기술에 영향을 받는다.

 - 애그리거트를 저장하고 조회하는 메서드는 필수이며, 필요에 따라 delete, count 등 메서드를 제공하고 커스터마이징해 별도의 구문으로 실행시키기도 한다.