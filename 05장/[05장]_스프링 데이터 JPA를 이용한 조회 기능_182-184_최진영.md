# 스프링 데이터 JPA를 이용한 조회 기능

## 5.4 리포지터리/DAO에서 스팩 사용하기 
> 스펙: 애그리거트가 특정 조건을 충족하는지를 검사할 때 사용하는 인터페이스

스펙을 충족하는 엔티티를 검색하고 싶다면 `findAll()` 메서드를 사용하면 됩니다.
```java
public interface OrderSummaryDao extends Repository<OrderSummary, String> {
  
  List<OrderSummary> findAll(Specification<OrderSummary> spec);
}
```

`findAll()` 메서드는 OrderSummary에 대한 검색 조건을 표현하는 스펙 인터페이스를 파라미터로 갖습니다.

위 메서드와, 앞서 작성한 스펙 구현체를 사용하면 특정 조건을 충족하는 엔티티를 검색할 수 있습니다.
```java
// 스펙 객체를 생성하고
Specification<OrderSummary> spec = new OrdererIdSpec("user1");

// findAll() 메서드를 이용해서 검색
List<OrderSummary> results = orderSummaryDao.findAll(spec);
```

---
## 5.5 스펙 조합

스프링 데이터 JPA가 제공하는 `스펙 인터페이스`는 `스펙을 조합할 수 있는 두 메서드를 제공`하고 있습니다.

1. `and()`: **두 스펙을 모두 충족하는 조건을 표현**하는 스펙을 생성
2. `or()`: **두 스펙 중 하나 이상 충족하는 조건을 표현**하는 스펙을 생성

두 메서드 다 기본 구현을 가진 `default 메서드`입니다.

```java
public interface Specification<T> extends Serializable {
  // ...
  default Specification<T> and(@Nullable Specification<T> other) { ... }
  default Specification<T> or(@Nullable Specification<T> other) { ... }
  
  // toPredicate() 생략
}
```

스펙을 조합하는 코드 예제는 아래와 같습니다.
```java
Specification<OrderSummary> spec1 = OrderSummarySpecs.ordererId("user1");
Specification<OrderSummary> spec2 = OrderSummarySpecs.orderDateBetween(
    LocalDateTime.of(2022, 1, 1, 0, 0, 0),
    LocalDateTime.of(2022, 1, 2, 0, 0, 0));

Specification<OrderSummary> spec3 = spec1.and(spec2); // spec1과 spec2를 모두 충족하는 spec3 생성

// 아래처럼 불필요한 변수 사용을 줄여도 된다.
Specification<OrderSummary> spec3 = OrderSummarySpecs.ordererId("user1")
    .and(OrderSummarySpecs.orderDateBetween(from, to));
```

스펙 인터페이스는 또한 `not()` 메서드도 제공합니다. `not()`은 정적 메서드로 조건을 반대로 적용할 때 사용합니다.
```java
// 정적 메서드 not()
Specification<OrderSummary> spec =
    Specification.not(OrderSummarySpecs.ordereId("userId"));
```

또한, `null` 가능성이 있는 스펙 객체와 다른 스펙을 조합해야 할 때가 있는데, 이 경우 `where()` 메서드를 사용하면 편리합니다.
```java
Specification<OrderSummary> nullableSpec = createNullableSpec(); // null 일 수 있음
Specification<OrderSummary> otherSpec = createOtherSpec();

// 매번 아래처럼 검사하려면 귀찮다.
Specification<OrderSummary> spec = nullableSpec == null ? otherSpec : nullableSpec.and(otherSpec);

// 정적 메서드 where()
Specification<OrderSummary> spec =
    Specification.where(createNullableSpec()).and(createOtherSpec());
```

`where()` 메서드는 정적 메서드인데, 파라미터로 null을 전달하면 `아무 조건도 생성하지 않는 스펙 객체를 리턴`하고 null이 아니면, 인자로 받은 스펙 객체를 그대로 리턴합니다.

> 🥸 메서드 정리
> 1. `and()`: **두 스펙을 모두 충족하는 조건을 표현**하는 스펙을 생성
> 2. `or()`: **두 스펙 중 하나 이상 충족하는 조건을 표현**하는 스펙을 생성
> 3. `not()`: 정적 메서드로 **조건을 반대로 적용할 때 사용**
> 4. `where()`: 파라미터로 null을 전달하면 `아무 조건도 생성하지 않는 스펙 객체를 리턴`하고 null이 아니면, 인자로 받은 스펙 객체를 그대로 리턴(nullable한 스펙을 조합할 때 유용하다.)

![andor.png](image%2Fandor.png)
![not.png](image%2Fnot.png)
![where.png](image%2Fwhere.png)

> `where()` 메서드를 보시면 `@Deprecated` 어노테이션이 붙은 것을 확인할 수 있습니다. `Spring Data`의 4.0 버전부터 사라질 예정이라고 합니다.