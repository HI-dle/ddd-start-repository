# 스프링 데이터 JPA를 이용한 조회 기능

---

## 5.6 정렬 지정하기


 - 스프링 데이터 JPA는 두 가지 방법을 사용해 정렬을 지정할 수 있다.
   - 메서드 이름에 OrderBy를 사용해 정렬 기준 지정
   - Sort를 인자로 전달

 - 특정 프로퍼티로 조회하는 find 메서드는 이름 뒤에 OrderBy를 사용해 정렬 순서를 지정할 수 있다.

```java
public interface OrderSummaryDao extends Repository<OrderSummary, String> {
  
  List<OrderSummary> findByOrdererIdOrderByNumberDesc(String ordererId);
}
```

 - 위 메서드는 ordererId 프로퍼티 값을 기준으로 검색 조건을 지정하고 number 프로퍼티 값 역순으로 정렬 쿼리를 생성한다.

 - 두 개 이상의 프로퍼티에 대한 정렬 순서를 지정할 수도 있다.
   - findByOrdererIdOrderByOrderDateDescNumberAsc 는 OrderDate 기준 내림차순 정렬 후 Number 기준 오름차순으로 정렬하는 쿼리를 작성한다.

 - 이처럼 정렬 조건이 늘어나게 되면 메서드 명이 지나치게 길어지는 단점이 있고 메서드 이름으로 정렬 순서가 정해지기 때문에 유동적이지 못한 단점이 있다.
 - 이 때, Sort를 사용하면 된다.
 - 스프링 데이터 JPA는 정렬에 순서를 지정하기 위한 Sort를 지원하고 다음과 같이 사용할 수 있다.

```java
public interface OrderSummaryDao extends Repository<OrderSummary, String> {
  List<OrderSummary> findByOrdererId(String ordererId, Sort sort);
   List<OrderSummary> findAll(Specification<OrderSummary> spec, Sort sort);
}
```

 - 스프링 데이터 JPA는 Sort를 사용해 정렬 쿼리를 생성한다.

```java
   Sort sort = Sort.by("number").ascending();
  List<OrderSummary> results = orderSummaryDao.findByOrdererId("user1", sort);
```

 - 위와 같이 사용하면 되고 number 프로퍼티 기준 오름차순 정렬을 표현하는 Sort를 생성한다.

```java
  Sort sort1 = Sort.by("number").ascending();
  Sort sort2 = Sort.by("orderDate").descending();
  Sort sort = sort1.and(sort2);
  
  //한 줄로 표현
  Sort sort = Sort.by("number").ascending().and(Sort.by("orderDate").descending());
```

 - 이처럼 사용시 2개 이상의 정렬 순서를 지정할 수 있다.



## 5.7 페이징 처리하기

 - 목록을 보여줄 때 전체 데이터 중 일부만 보여주는 페이징 처리는 기본으로 스프링 데이터 JPA는 Pageable을 제공한다.

```java

public interface OrderSummaryDao extends Repository<OrderSummary, String> {

   List<OrderSummary> findByNameLike(String name, Pageable pageable);
}
```

 - Pageable은 인터페이스로 실제 객체는 PageRequrest 클래스를 이용해 생성한다.

```java
  PageRequest pageReq = PageRequest.of(1,10);
  List<OrderSummary> orderSummaries = OrderSummaryDao.findByNameLike("사용자%", pageReq);
```

 - of 메서드의 인자는 1번쨰 페이지의 10개 데이터로 페이지 수는 0부터 시작한다 그러니 11~20 까지의 데이터가 들어가게 된다. 이외로 of 메서드에는 정렬 조건을 추가할 수 있는데 이전에 봤던 Sort를 인자로 넘기면 된다.

```java

public interface OrderSummaryDao extends Repository<OrderSummary, String> {

   Page<OrderSummary> findByBlocked(boolean blocked, Pageable pageable);
}
```

 - 위는 Page 타입을 통해 데이터 목록뿐만 아닌 조건에 해당하는 전체 개수도 구할 수 있다.

 - Pageable을 사용하는 메서드의 리턴 타입이 Page일 경우 스프링 데이터 JPA는 목록 조회 쿼리와 함께 COUNT 쿼리도 실행해 조건에 해당하는 데이터 개수를 구한다.
 - 이전에 확인한 스펙을 사용하는 findAll() 메서드도 Pageable을 사용할 수 있다.

```java
   Page<OrderSummary> findAll(Specification<OrderSummary> spec, Pageable pageable);
```

> 프로퍼티를 비교하는 findBy프로퍼티 형식의 메서드는 Pageable 타입을 사용하더라도 리턴 타입이 List면 COUNT 쿼리를 실행하지 않는다.
> 
> 페이징 처리와 관련된 정보가 필요 없다면 Page 타입이 아닌 List로 반환 받아 불필요한 COUNT 쿼리를 줄일 수 있다.

> 반면 스펙을 사용하는 findAll의 경우 List로 반환 하더라도 COUNT 쿼리는 발생한다.
> 
> 스펙을 사용하며 List로 반환하는 findAll 페이징 처리를 하고 싶다면 스프링 데이터 JPA가 제공하는 커스텀 리포지터리 기능을 이용해 직접 구현해야 한다.


 - 처음부터 N개의 데이터가 필요하면 Pageable 없이 findFirstN 형식의 메서드를 사용할 수 있다. Top을 사용할 수 있으며, 뒤에 숫자가 없다면 한 개 결과만 리턴한다.

```java
   List<OrderSummary> findFirst3ByNameLikeOrderByName(String name);
```