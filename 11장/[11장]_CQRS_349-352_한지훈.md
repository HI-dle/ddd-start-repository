# CQRS

---


 - 명령 모델과 조회 모델

![image_11_4.png](image%2Fimage_11_4.png)


 - 명령 모델과 조회 모델이 같은 구현 기술을 사용할 수 있다.
 - 이전에서는 JPQL을 통한 동적 인스턴스 생성과 하이버네이트의 @SubSelect를 이용하는 방법을 설명했는데, 동적 인스턴스로 사용할 클래스와 @SubSelect를 적용한 클래스가 조회 모델에 해당한다.
 - 위 이미지와 같이 명령 모델과 조회 모델이 서로 다른 데이터 저장소를 사용할 수 있다. 명령 모델은 트랜잭션을 지원하는 RDBMS를, 조회 모델은 성능이 좋은 메모리 기반 NoSQL(redis등)을 사용할 수 있을 것이다.


![image_11_5.png](image%2Fimage_11_5.png)


 - 각 저장소간 데이터 동기화는 이벤트를 활용해 처리하며, 명령 모델에서의 상태 변경이 발생하는 시점 이벤트를 통해 조회 모델에 반영하는 구조이다.
 - 서로 다른 저장소의 경우 동기화 시점에 따라 구현 방식이 달라질 수 있다.
   - 즉시 반영이 되어야 하는 경우 글로벌 트랜잭션을 사용해 실시간으로 동기화할 수 있다.
   - 동기 이벤트와 글로벌 트랜잭션을 사용하면 전반적인 성능이 떨어지는 단점이 있다.

 - 서로 다른 저장소의 데이터를 특정 시간 안에만 동기화 해도 된다면 비동기로 데이터를 전송하면 된다.
   - 예시로 통계 처리 목적으로 조회 저장소를 구축했다면, 통계 데이터는 즉시 일관성이 맞춰지지 않아도 되는 성향이 있고 이 경우 비동기로 데이터를 보냄으로 데이터 동기화로 인한 성능 저하를 방지할 수 있다.

> CQRS 패턴을 적용하기 위해 사용해야 할 필수 기술이 정해져 있는 것은 아니다. JPA만을 통해 구현할 수 있다. 이때 명령 모델은 JPA로 조회 모델은 SQL을 통해 구현할 수 있다.


## 11.2.1 웹과 CQRS

 - 일반적으로 웹 서비스는 상태를 변경하는 요청보다는 조회 요청이 많다.
   - 예시로 온라인 쇼핑몰이 있다면 주문 요청보다 카탈로그 조회 및 제품의 상세 정보를 조회하는 빈도가 높다.
 - 이러한 특성을 가진 서비스는 조회 성능을 높이기 위해 다양한 기법을 사용한다.
   - 쿼리 최적화
   - 메모리에 조회 데이터 캐싱
   - 조회 전용 저장소 구현
 - 이러한 기법을 사용해 성능을 최적화 하고 결과적으로 CQRS를 적용하는 것과 같은 효과를 만든다.
 - 캐싱의 경우 DB에 저장된 데이터를 그대로 저장하는 것 보다 화면에 맞는 모양으로 변환한 데이터를 캐싱하는 것이 성능에 유리하다. 이는 조회 모델을 캐시 하는 것이다.
 - 캐싱 전이나 캐시 삭제 이후로 DB에 조회 되는 경우 빠르고 자원을 덜 사용하기 위해 조회 쿼리를 최적화 한다.

 - 대규모 서비스를 제공하는 웹 서비스의 경우 알게 모르게 CQRS를 적용한다. 단지 명시적으로 명령 및 조회 모델을 구현하지 않을 뿐이다.
 - 조회 속도를 위해 별도 처리를 하고 있다면 명령과 조회 모델을 구분해 구현하는 것을 권장한다.

## 11.2.2 CQRS 장단점

 - CQRS 패턴을 적용할 때 얻을 수 있는 장점은 명령 모델을 구현할 때 도메인 자체에 집중할 수 있다는 점으로 복잡한 도메인은 주로 상태 변경 로직이 복잡한데 명령 모델과 조회 모델을 구분하면 조회 성능을 위한 코드가 명령 모델에 없으므로 도메인 로직을 구현하는 데 집중할 수 있다. 또한 명령 모델에서 조회 관련 로직이 사라져 복잡도가 낮아진다.
 - 다른 장점은 조회 성능을 향상 시키는데 유리하단 점이다. 조회 단위로 캐싱, 조회에 특화된 쿼리, 조회 저장소를 통한 조회 처리량 상승 이고 조회 성능을 높이기 위한 코드가 명령 모델에 영향을 주지 않는다는 것이다.

![image_11_6.png](image%2Fimage_11_6.png)

 - 단점
   - 구현해야 할 코드가 많아진다.
     - 단일 모델을 사용할 때 복잡성으로 인한 비용과 조회 모델 구현을 통한 비용을 따져봐야 한다.
     - 도메인이 복잡하거나 대규모 트래픽의 경우 조회 전용 모델을 사용하는 것이 향후 유지 보수에 유리하다.
     - 반면 낮은 트래픽과 단순한 도메인의 경우 비용이 오히려 조회 모델 구현이 더 들 수 있다.
   - 더 많은 구현 기술을 필요로 한다.
     - 명령 모델과 조회 모델을 다른 구현 기술을 사용해 구현 하기도 하며, 다른 저장소를 사용하기도 하고 데이터 동기화를 위한 메시징 시스템을 도입해야 할 수 있다.

 ---
 - 장단점을 고려해 CQRS를 도입할지 여부를 결정해야 하고 비용의 측정 및 서비스의 복잡성 등을 객관적으로 판단해서 자신의 서비스에 필요한 부분인지 판단할 수 있어야 한다.
